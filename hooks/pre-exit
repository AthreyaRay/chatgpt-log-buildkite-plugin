#!/bin/bash
set -euo pipefail

echo "--- Copying Buildkite job log to local file"
cp "$BUILDKITE_JOB_LOG_TMPFILE" ./buildkite-job.log
LOG_FILE="./buildkite-job.log"

echo "--- Reading last 600 lines"
LOG_CHUNK=$(tail -n 600 "$LOG_FILE")

echo "--- Getting OpenAI API key from Secrets"
OPENAI_API_KEY=$(buildkite-agent secret get "open_ai_key")

echo "--- Sending log to ChatGPT for analysis"
RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -H "Content-Type: application/json" \
  -d "{
    \"model\": \"gpt-4o\",
    \"messages\": [
      {\"role\": \"system\", \"content\": \"You are a CI assistant. Analyze this Buildkite job log and explain what went wrong and how to fix it.\"},
      {\"role\": \"user\", \"content\": \"$LOG_CHUNK\"}
    ],
    \"temperature\": 0.3,
    \"max_tokens\": 1500
  }")

SUGGESTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

echo "--- Annotating build with ChatGPT's suggestion"
echo "$SUGGESTION" | buildkite-agent annotate --style "info" --context "chatgpt-log"

echo "--- Cleaning up"
rm -f "$LOG_FILE"
