#!/bin/bash
set -euo pipefail

echo "--- Getting job log"
LOG_FILE="$BUILDKITE_JOB_LOG_TMPFILE"

echo "--- Analyzing log with ChatGPT"
SUGGESTION=$(bash "$(dirname "$0")/../bin/analyze-log.sh" "$LOG_FILE")

echo "--- Annotating build with ChatGPT's suggestion"
echo "$SUGGESTION" | buildkite-agent annotate --style "info" --context "chatgpt-log"
